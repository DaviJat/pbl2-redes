<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Servidor A - Sistema de Reservas</title>
  <script>
    // Função para buscar trechos e atualizar a interface
    async function carregarTrechos() {
      try {
        const response = await fetch('http://127.0.0.1:5001/trechos');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('trechos').innerHTML = JSON.stringify(data, null, 2);
            logStatus("Trechos carregados com sucesso.");
        } else {
          logStatus("Erro ao carregar trechos.");
        }
      } catch (error) {
        console.error("Erro ao carregar trechos:", error);
        logStatus("Erro ao carregar trechos.");
      }
    }

    // Função para iniciar reserva
    async function iniciarReserva() {
      const trechoId = document.getElementById('trechoId').value;
      
      try {
        const response = await fetch('/reserve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trecho_id: trechoId })
        });
        const data = await response.json();
        if (response.ok) {
          logStatus(`Reserva solicitada para o trecho ${trechoId}: ${data.status}`);
        } else {
          logStatus(`Erro ao solicitar reserva para o trecho ${trechoId}: ${data.error}`);
        }
      } catch (error) {
        console.error("Erro ao iniciar reserva:", error);
        logStatus("Erro ao iniciar reserva.");
      }
    }

    // Função para confirmar compra
    async function confirmarCompra() {
      const trechoId = document.getElementById('trechoIdCompra').value;

      try {
        const response = await fetch('/confirm_purchase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trecho_id: trechoId })
        });
        const data = await response.json();
        if (response.ok) {
          logStatus(`Compra confirmada para o trecho ${trechoId}: ${data.status}`);
          carregarTrechos(); // Atualizar a lista de trechos
        } else {
          logStatus(`Erro ao confirmar compra para o trecho ${trechoId}`);
        }
      } catch (error) {
        console.error("Erro ao confirmar compra:", error);
        logStatus("Erro ao confirmar compra.");
      }
    }

    // Função para atualizar a log
    function logStatus(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    }
  </script>
</head>
<body onload="carregarTrechos()">
  <h1>Servidor A - Sistema de Reservas</h1>

  <section>
    <h2>Trechos Disponíveis</h2>
    <pre id="trechos">Carregando trechos...</pre>
    <button onclick="carregarTrechos()">Atualizar Trechos</button>
  </section>

  <section>
    <h2>Iniciar Reserva de Trecho</h2>
    <form onsubmit="event.preventDefault(); iniciarReserva();">
      <label for="trechoId">ID do Trecho:</label>
      <input type="text" id="trechoId" placeholder="Ex: T1" required>
      <button type="submit">Solicitar Reserva</button>
    </form>
  </section>

  <section>
    <h2>Confirmar Compra de Trecho</h2>
    <form onsubmit="event.preventDefault(); confirmarCompra();">
      <label for="trechoIdCompra">ID do Trecho para Compra:</label>
      <input type="text" id="trechoIdCompra" placeholder="Ex: T1" required>
      <button type="submit">Confirmar Compra</button>
    </form>
  </section>

  <section>
    <h2>Logs</h2>
    <div id="log" style="background-color: #f0f0f0; padding: 10px; max-height: 200px; overflow-y: auto;"></div>
  </section>
</body>
</html>
